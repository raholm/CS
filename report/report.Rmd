---
title: "Computational Statistics"
subtitle: Lab 4
author: "Emil K Svensson and Rasmus Holm"
date: '`r Sys.Date()`'
output:
    pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
pifunc <- function(x) {
    x^5 * exp(-x)
}

lognormalfuncs <- list(propsample=function(x) { rlnorm(1, meanlog=x, sdlog=1) },
                       propdensity=function(x, y) { dlnorm(x, meanlog=y, sdlog=1) },
                       targetdensity=pifunc)

chisquarefuncs <- list(propsample=function(x) { rchisq(1, df=floor(x + 1)) },
                       propdensity=function(x, y) { dchisq(x, df=floor(y + 1)) },
                       targetdensity=pifunc)

metropolis_hastings <- function(X0, iters, funcs) {
    x <- X0
    values <- rep(0, iters)

    alpha <- function(x, y) {
        numerator <- funcs$targetdensity(y) * funcs$propdensity(x, y)
        denominator <- funcs$targetdensity(x) * funcs$propdensity(y, x)
        numerator / denominator
    }

    for (i in 1:iters) {
        y <- funcs$propsample(x)
        u <- runif(1)

        if (u < alpha(x, y)) {
            x = y
        }

        values[i] <- x
    }

    values
}

iters <- 10000
X0 <- 1

x <- 0:20
y <- sapply(x, function(x) pifunc(x))
```

```{r}
set.seed(123456)
samples1 <- metropolis_hastings(X0=X0, iters=iters, funcs=lognormalfuncs)
mean(samples1)
plot(samples1)
```

```{r}
set.seed(123456)
samples2 <- metropolis_hastings(X0=X0, iters=iters, funcs=chisquarefuncs)
mean(samples2)
plot(samples2)
```

```{r}
x <- 0:20
y <- sapply(x, function(x) pifunc(x))

oldpar <- par(mfrow = c(1, 3))

hist(y)
hist(samples1)
hist(samples2)

```

```{r, echo=FALSE}
par(oldpar)
```


## Geldman rubin 
```{r}
Geldman<-function(x){
  k <- nrow(x)
  n <- ncol(x)
  
  B <- (n / (k - 1)) * sum((rowMeans(x) - mean(x))^2)   
  
  W <- sum((x - rowMeans(x))^2) / (k * (n - 1))

  VarV <- ((n - 1) / n) * W + B / n
  
  sqrtR <- sqrt(VarV / W)
  sqrtR
}

resultMatrix <- do.call(rbind, lapply(1:10, FUN = function(x) metropolis_hastings(X0 = x,iters = iters, funcs = chisquarefuncs) ))

GeldmanRes <- Geldman(resultMatrix)
GeldmanRes

```




